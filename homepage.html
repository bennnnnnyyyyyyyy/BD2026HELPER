<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ben's DME Data Hub | Industrial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Geist:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        @keyframes pulse-pip {

            0%,
            100% {
                box-shadow: 0 0 4px rgba(0, 112, 255, 0.6), inset 0 0 2px rgba(0, 112, 255, 0.8);
            }

            50% {
                box-shadow: 0 0 8px rgba(0, 112, 255, 0.9), inset 0 0 4px rgba(0, 112, 255, 1);
            }
        }

        @keyframes slideInFromTop {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        :root {
            --void: #0B0E14;
            --void-light: #141820;
            --void-lighter: #1F2937;
            --steel: #9CA3AF;
            --steel-dark: #6B7280;
            --electric-blue: #0070FF;
            --electric-blue-hover: #0057CC;
            --neon-mint: #00D9A3;
            --neon-red: #FF4444;
            --neon-amber: #FFB82E;
            --text-primary: #E5E7EB;
            --text-secondary: #A3ACBE;
            --border-color: #1F2937;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--void);
            color: var(--text-primary);
            min-height: 100vh;
            background-image:
                linear-gradient(0deg, transparent 24%, rgba(31, 41, 55, 0.5) 25%, rgba(31, 41, 55, 0.5) 26%, transparent 27%, transparent 74%, rgba(31, 41, 55, 0.5) 75%, rgba(31, 41, 55, 0.5) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(31, 41, 55, 0.5) 25%, rgba(31, 41, 55, 0.5) 26%, transparent 27%, transparent 74%, rgba(31, 41, 55, 0.5) 75%, rgba(31, 41, 55, 0.5) 76%, transparent 77%, transparent);
            background-size: 48px 48px;
            animation: fadeIn 0.6s ease-out;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            animation: slideInFromTop 0.6s ease-out;
        }

        h1 {
            font-size: 3rem;
            font-weight: 700;
            color: var(--electric-blue);
            margin-bottom: 15px;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 20px rgba(0, 112, 255, 0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .tool-card {
            background: var(--void-light);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 35px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--electric-blue), var(--neon-mint));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tool-card:hover {
            border-color: var(--electric-blue);
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 112, 255, 0.2);
        }

        .tool-card:hover::before {
            transform: scaleX(1);
        }

        .tool-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--electric-blue), var(--neon-mint));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 20px;
            animation: pulse-pip 2s infinite;
        }

        .tool-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .tool-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .tool-features {
            list-style: none;
            margin-bottom: 25px;
        }

        .tool-features li {
            color: var(--text-secondary);
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 0.9rem;
        }

        .tool-features li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--neon-mint);
            font-weight: bold;
        }

        .btn {
            background: var(--electric-blue);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--electric-blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 112, 255, 0.3);
        }

        .btn-secondary {
            background: var(--void-lighter);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--void-light);
            border-color: var(--electric-blue);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-new {
            background: rgba(0, 217, 163, 0.2);
            color: var(--neon-mint);
            border: 1px solid var(--neon-mint);
        }

        .status-beta {
            background: rgba(255, 184, 46, 0.2);
            color: var(--neon-amber);
            border: 1px solid var(--neon-amber);
        }

        footer {
            text-align: center;
            margin-top: 80px;
            padding: 30px 0;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .hidden {
            display: none;
        }

        /* Enrichment Tool Styles */
        .enrichment-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        .back-btn {
            background: var(--void-light);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 30px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: var(--electric-blue);
            color: var(--electric-blue);
        }

        .file-upload-section {
            margin-bottom: 25px;
        }

        .file-upload-box {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: var(--void-light);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .file-upload-box:hover {
            background: var(--void-lighter);
            border-color: var(--electric-blue);
        }

        .file-upload-box.has-file {
            border-color: var(--neon-mint);
            background: rgba(0, 217, 163, 0.05);
        }

        .file-label {
            font-weight: 600;
            color: var(--electric-blue);
            margin-bottom: 10px;
            display: block;
            text-align: left;
            font-size: 0.9rem;
        }

        input[type="file"] {
            display: none;
        }

        .file-name {
            color: var(--neon-mint);
            font-weight: 600;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
        }

        .progress-bar-container {
            background: var(--void-lighter);
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--electric-blue), var(--neon-mint));
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .status-log {
            background: var(--void-light);
            color: var(--neon-mint);
            padding: 20px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.8;
            border: 1px solid var(--border-color);
        }

        .status-log div {
            margin-bottom: 5px;
        }

        .summary {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: var(--void-light);
            border-radius: 16px;
            border: 2px solid var(--neon-mint);
        }

        .summary h3 {
            color: var(--neon-mint);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat {
            background: var(--void-lighter);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--electric-blue);
        }

        /* --- NPI Search Specific Styles --- */
        .search-page-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .controls-area {
            background: var(--void-light);
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            /* transition: all 0.15s; */
        }

        .search-wrapper {
            flex: 1;
            position: relative;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            background: var(--void);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 12px 10px 36px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--electric-blue);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            width: 16px;
            height: 16px;
        }

        /* Table & Data Styles */
        .table-container {
            flex: 1;
            overflow: auto;
            background: var(--void-light);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            position: sticky;
            top: 0;
            background: var(--void-light);
            z-index: 10;
            padding: 12px 15px;
            color: var(--electric-blue);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
        }

        td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tbody tr:hover {
            background: rgba(0, 112, 255, 0.05);
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: var(--void-light);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: start;
            background: var(--void);
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .info-item label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .info-item span {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Filter Section */
        .filter-section {
            background: var(--void);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .filter-section.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Home Page -->
    <div id="homePage">
        <div class="container">
            <header>
                <h1>üè• Ben's DME Data Hub</h1>
                <p class="subtitle">Professional tools for NPPES data management and enrichment</p>
            </header>

            <div class="tools-grid">
                <!-- NPI Enrichment Tool -->
                <div class="tool-card" onclick="openTool('enrichment')">
                    <div class="status-badge status-new">NEW</div>
                    <div class="tool-icon">üìä</div>
                    <h2 class="tool-title">NPI Data Enrichment</h2>
                    <p class="tool-description">
                        Automatically fill missing NPI numbers, Authorized Official names, and phone numbers from the
                        NPPES database.
                    </p>
                    <ul class="tool-features">
                        <li>Extract NPIs from URLs automatically</li>
                        <li>Match by business name + state</li>
                        <li>Fill authorized official contact info</li>
                        <li>Process thousands of records in seconds</li>
                    </ul>
                    <button class="btn">Launch Enrichment Tool ‚Üí</button>
                </div>

                <!-- NPI Search Engine -->
                <div class="tool-card" onclick="window.open('ben_npi_search.html', '_blank')">
                    <div class="status-badge status-beta">BETA</div>
                    <div class="tool-icon">üîç</div>
                    <h2 class="tool-title">NPI Search Engine</h2>
                    <p class="tool-description">
                        Advanced search and filtering interface for exploring NPPES data with real-time results.
                    </p>
                    <ul class="tool-features">
                        <li>Search by NPI, name, or phone</li>
                        <li>Advanced filters and columns</li>
                        <li>Export to CSV/JSON</li>
                        <li>Session persistence</li>
                    </ul>
                    <button class="btn btn-secondary">Open in New Tab ‚Üí</button>
                </div>

                <!-- Power Dialer -->
                <div class="tool-card" onclick="window.open('dialer.html', '_blank')">
                    <div class="status-badge status-new">NEW</div>
                    <div class="tool-icon">üìû</div>
                    <h2 class="tool-title">Power Dialer</h2>
                    <p class="tool-description">
                        Import CSV leads, auto-enrich with NPI data, one-click dial, and export results with
                        dispositions.
                    </p>
                    <ul class="tool-features">
                        <li>CSV drag & drop import</li>
                        <li>NPI API auto-enrichment</li>
                        <li>One-click tel: dialing</li>
                        <li>Disposition logging & export</li>
                    </ul>
                    <button class="btn">Launch Power Dialer ‚Üí</button>
                </div>
            </div>

            <footer>
                <p>Built for healthcare data professionals | All data sourced from CMS NPPES</p>
            </footer>
        </div>
    </div>

    <!-- Enrichment Tool Page -->
    <div id="enrichmentPage" class="hidden">
        <div class="enrichment-container">
            <button class="back-btn" onclick="backToHome()">‚Üê Back to Home</button>

            <header style="text-align: center; margin-bottom: 40px;">
                <h1 style="font-size: 2rem;">NPI Data Enrichment Tool</h1>
                <p class="subtitle">Upload your files to automatically enrich DME data</p>
            </header>

            <div class="file-upload-section">
                <label class="file-label">1. NPPES Reference Database</label>
                <div class="file-upload-box" id="refBox" onclick="document.getElementById('refFile').click()">
                    <div>Click to select NPPES database file (CSV)</div>
                    <div class="file-name" id="refFileName"></div>
                </div>
                <input type="file" id="refFile" accept=".csv">
            </div>

            <div class="file-upload-section">
                <label class="file-label">2. Target DME Sheet</label>
                <div class="file-upload-box" id="targetBox" onclick="document.getElementById('targetFile').click()">
                    <div>Click to select your target file (CSV)</div>
                    <div class="file-name" id="targetFileName"></div>
                </div>
                <input type="file" id="targetFile" accept=".csv">
            </div>

            <button class="btn" id="processBtn" disabled onclick="processFiles()"
                style="width: 100%; padding: 16px; font-size: 1rem;">
                üöÄ Start Enrichment Process
            </button>

            <div class="progress-section" id="progressSection">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="status-log" id="statusLog"></div>
            </div>

            <div class="summary" id="summary">
                <h3>üìä Processing Complete!</h3>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="stat-label">Total Records</div>
                        <div class="stat-value" id="totalRecords">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">NPI Matches</div>
                        <div class="stat-value" id="npiMatches">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Name+State Matches</div>
                        <div class="stat-value" id="nameMatches">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Phone Matches</div>
                        <div class="stat-value" id="phoneMatches">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-value" id="successRate">0%</div>
                    </div>
                </div>
                <button class="btn" id="downloadBtn" onclick="downloadResults()"
                    style="width: 100%; padding: 16px; font-size: 1rem;">
                    ‚¨áÔ∏è Download Enriched Data
                </button>
            </div>
        </div>
    </div>

    <script>
        let refData = null;
        let targetData = null;
        let enrichedData = null;

        function openTool(tool) {
            if (tool === 'enrichment') {
                document.getElementById('homePage').classList.add('hidden');
                document.getElementById('enrichmentPage').classList.remove('hidden');
            }
        }

        function backToHome() {
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('enrichmentPage').classList.add('hidden');
        }

        // File upload handlers
        document.getElementById('refFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('refFileName').textContent = file.name;
                document.getElementById('refBox').classList.add('has-file');
                checkFilesReady();
            }
        });

        document.getElementById('targetFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('targetFileName').textContent = file.name;
                document.getElementById('targetBox').classList.add('has-file');
                checkFilesReady();
            }
        });

        function checkFilesReady() {
            const refFile = document.getElementById('refFile').files[0];
            const targetFile = document.getElementById('targetFile').files[0];
            document.getElementById('processBtn').disabled = !(refFile && targetFile);
        }

        function addLog(message) {
            const log = document.getElementById('statusLog');
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function updateProgress(percent, text) {
            const bar = document.getElementById('progressBar');
            bar.style.width = percent + '%';
            bar.textContent = text || percent + '%';
        }

        function extractNPI(value) {
            if (!value) return null;
            const match = String(value).match(/(\d{10})/);
            return match ? match[1] : null;
        }

        function normalizeName(name) {
            if (!name) return '';
            return String(name).toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
        }

        function normalizePhone(phone) {
            if (!phone) return '';
            const cleaned = String(phone).replace(/\D/g, '');
            return cleaned.length > 10 ? cleaned.slice(-10) : cleaned;
        }

        async function processFiles() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('processBtn').disabled = true;

            const refFile = document.getElementById('refFile').files[0];
            const targetFile = document.getElementById('targetFile').files[0];

            try {
                addLog('Loading target file...');
                updateProgress(10, 'Loading target...');
                targetData = await parseCSV(targetFile);
                addLog(`‚úì Loaded ${targetData.length} target records`);

                // Validation
                const headers = targetData.length > 0 ? Object.keys(targetData[0]) : [];
                const requiredCols = ['Legalbusinessname', 'State', 'OfficePhone'];
                const missing = requiredCols.filter(col => !headers.includes(col));
                if (missing.length > 0) {
                    addLog(`‚ö†Ô∏è WARNING: Missing columns in target file: ${missing.join(', ')}. Matching might be limited.`);
                }

                addLog('Loading NPPES database (this may take a moment)...');
                updateProgress(20, 'Loading NPPES...');
                refData = await parseCSV(refFile);
                addLog(`‚úì Loaded ${refData.length} reference records`);

                addLog('Starting enrichment process...');
                updateProgress(40, 'Processing...');

                const initialCount = targetData.length;
                let npiMatches = 0;
                let nameMatches = 0;
                let phoneMatches = 0; // Track phone matches

                addLog('Building lookup indices...');
                const npiMap = new Map();
                const nameStateMap = new Map();
                const phoneMap = new Map(); // New Phone Map

                refData.forEach(row => {
                    const npi = String(row['NPI'] || '').trim();
                    const name = normalizeName(row['Provider Organization Name (Legal Business Name)']);
                    const state = String(row['Provider Business Practice Location Address State Name'] || '').trim();

                    // Reference phone fields
                    const refBizPhone = normalizePhone(row['Provider Business Practice Location Address Telephone Number']);
                    const refAuthPhone = normalizePhone(row['Authorized Official Telephone Number']);

                    if (npi && !npiMap.has(npi)) {
                        npiMap.set(npi, row);
                    }

                    if (name && state) {
                        const key = `${name}|${state}`;
                        if (!nameStateMap.has(key)) {
                            nameStateMap.set(key, row);
                        }
                    }

                    // Index by phone numbers (keep first occurrence)
                    if (refBizPhone && refBizPhone.length >= 10 && !phoneMap.has(refBizPhone)) phoneMap.set(refBizPhone, row);
                    if (refAuthPhone && refAuthPhone.length >= 10 && !phoneMap.has(refAuthPhone)) phoneMap.set(refAuthPhone, row);
                });

                addLog('Enriching records...');
                updateProgress(60, 'Enriching...');

                enrichedData = targetData.map((row, idx) => {
                    if (idx % 100 === 0) {
                        updateProgress(60 + (idx / targetData.length) * 30, `Processing ${idx}/${targetData.length}`);
                    }

                    const enriched = { ...row };
                    let matched = false;

                    const npiClean = extractNPI(row['NPI']);
                    if (npiClean && npiMap.has(npiClean)) {
                        const match = npiMap.get(npiClean);
                        enriched['AuthOfficialName'] = `${match['Authorized Official First Name'] || ''} ${match['Authorized Official Last Name'] || ''}`.trim();
                        enriched['AuthPhone'] = match['Authorized Official Telephone Number'] || '';
                        enriched['NPI'] = npiClean;
                        npiMatches++;
                        matched = true;
                    }

                    if (!matched) {
                        const name = normalizeName(row['Legalbusinessname']);
                        const state = String(row['State'] || '').trim();
                        const key = `${name}|${state}`;

                        if (nameStateMap.has(key)) {
                            const match = nameStateMap.get(key);
                            enriched['AuthOfficialName'] = `${match['Authorized Official First Name'] || ''} ${match['Authorized Official Last Name'] || ''}`.trim();
                            enriched['AuthPhone'] = match['Authorized Official Telephone Number'] || '';
                            enriched['NPI'] = match['NPI'] || npiClean || '';
                            nameMatches++;
                            matched = true;
                        }
                    }

                    // 3. Try Phone Match
                    if (!matched) {
                        const targetPhone = normalizePhone(row['OfficePhone']);
                        if (targetPhone && phoneMap.has(targetPhone)) {
                            const match = phoneMap.get(targetPhone);
                            enriched['AuthOfficialName'] = `${match['Authorized Official First Name'] || ''} ${match['Authorized Official Last Name'] || ''}`.trim();
                            enriched['AuthPhone'] = match['Authorized Official Telephone Number'] || '';
                            enriched['NPI'] = match['NPI'] || npiClean || '';
                            phoneMatches++;
                            matched = true;
                        }
                    }

                    if (!matched) {
                        enriched['AuthOfficialName'] = enriched['AuthOfficialName'] || '';
                        enriched['AuthPhone'] = enriched['AuthPhone'] || '';
                        enriched['NPI'] = npiClean || enriched['NPI'] || '';
                    }

                    return enriched;
                });

                updateProgress(100, 'Complete!');
                addLog('‚úì Enrichment complete!');

                const successRate = ((npiMatches + nameMatches + phoneMatches) / initialCount * 100).toFixed(1);
                document.getElementById('totalRecords').textContent = initialCount;
                document.getElementById('npiMatches').textContent = npiMatches;
                document.getElementById('nameMatches').textContent = nameMatches;
                document.getElementById('phoneMatches').textContent = phoneMatches;
                document.getElementById('successRate').textContent = successRate + '%';
                document.getElementById('summary').style.display = 'block';

                addLog(`üìä Summary: ${npiMatches} NPI, ${nameMatches} Name, ${phoneMatches} Phone matches`);
                addLog(`‚úÖ Success rate: ${successRate}%`);

            } catch (error) {
                addLog(`‚ùå ERROR: ${error.message}`);
                console.error(error);
                document.getElementById('processBtn').disabled = false;
            }
        }

        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: results => resolve(results.data),
                    error: error => reject(error)
                });
            });
        }

        function downloadResults() {
            if (!enrichedData) return;

            const outputData = enrichedData.map(row => ({
                'Legalbusinessname': row['Legalbusinessname'] || '',
                'State': row['State'] || '',
                'OfficePhone': row['OfficePhone'] || '',
                'AuthOfficialName': row['AuthOfficialName'] || '',
                'AuthPhone': row['AuthPhone'] || '',
                'Specialitieslist': row['Specialitieslist'] || '',
                'Supplieslist': row['Supplieslist'] || '',
                'NPI': row['NPI'] || ''
            }));

            const csv = Papa.unparse(outputData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FILLED_DME_SHEET.csv';
            a.click();
            URL.revokeObjectURL(url);

            addLog('‚úÖ File downloaded successfully!');
        }
    </script>
</body>

</html>